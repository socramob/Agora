extends ../../../views/layoutOnlyMain

include  ../../../views/formComponents
include ./mixins

block title
  = activityResultName

block content
  #detail-overlay.noisy_red
    .header
      p.close
        a.close-centered(href='#', style='color: white;')
          span(class='glyphicon glyphicon-remove')
          | &nbsp;
          = t('general.close')
      p.tag
        | #lovelace
    .slideshow
      .prev-img
        img(width='100', height='100')
        a#prev-img
          span(class='glyphicon glyphicon-chevron-up')
      a#image-detail-link
        img#image-detail.current-img
      .next-img
        img(width='100', height='100')
        a#next-img(href='#')
          span(class='glyphicon glyphicon-chevron-down')

  .row
    .col-md-12
      h2(style='margin-top: 5px;')= activityResultName

  .row
    .col-md-12
      form(id='recordForm',role='form',method='POST',action=recordImagePath + '?_csrf=' + encodeURIComponent(csrf_token),enctype='multipart/form-data')
        +csrf
        div
          span.btn.btn-primary.btn-file.record(style="width: 100%")
            i.glyphicon.glyphicon-camera &nbsp;
            span= t('activityresults.record_image')
            input#input-file(type="file",accept="image/*",name="image")
        div#previewContainer(style="display: none")
          img#preview(style="max-width: 100%")
          div
            button(type="submit").btn.btn-success.pull-right= t('activityresults.submit')
            span#btn-cancel.btn.btn-warning= t('activityresults.cancel')


      script.
        function getPreview(files, callback) {
          if(!files || !files[0])
            return null;
          var reader = new FileReader();
          reader.onload = function (e) {
            callback(e.target.result);
          };
          reader.readAsDataURL(files[0]);
        }

        $("#input-file").on("change", function () {
          getPreview(this.files, function (imagedata) {
            $("img#preview").attr("src", imagedata);
            $("#previewContainer").slideDown();
          });
          $('.record').hide();
        });

        $('#btn-cancel').click(function () {
          $('#previewContainer').slideUp(200, function() {
            $('.record').slideDown();
          });
        });

  hr
  each columns, title in days
    .row
      .col-md-12
        h3(style='margin-top: 5px;')= moment(title*1000).lang(language).format("dddd, l")

        - var i = 0;
        table.row.timeline
          tr.table-row
            each column, columnTitle in columns
              th.col-xs-3.col-without-padding.venue(class=getBackgroundForIndex(i++))
                p.tag= '#' + columnTitle

          - i = 0;
          tr.table-row(style='display: table-row')
            each column, columnTitle in columns
              td.col-xs-3.col-without-padding.venue(class=getBackgroundForIndex(i++))
                each img in column
                  a.thumb(href=img.uri, data-columntitle='#'+columnTitle)
                    img.thumb(src=img.uri + '?size=thumb', alt=img.title, title=img.title)
                    span.small(style="color: black")
                      +thumbnailInfos(img)

  script(type='text/javascript').
    function resizeImageFromFile(file, MAX_WIDTH, MAX_HEIGHT, callback) {
          // Load via FileReader
          var fr = new FileReader();
          fr.onload = function(e) {
            getDimensions(e.target.result, function(width, height, img) {
            var newWidth = width;
            var newHeight = height;
            var aspectRatio = width/height;
            // Image is wider than tall
            if(width > MAX_WIDTH && aspectRatio >= 1) {
            newWidth = MAX_WIDTH;
            newHeight = MAX_WIDTH / aspectRatio
            } else if(height > MAX_HEIGHT && aspectRatio <= 1) {
            newWidth = MAX_HEIGHT * aspectRatio;
            newHeight = MAX_HEIGHT;
            }
            resizeImage(img, newWidth, newHeight, function (canvas) {
              callback(canvas.toDataURL('image/jpeg', 0.8));
              })
            });
          }
          fr.readAsDataURL(file);
          function resizeImage(imgElement, width, height, callback) {
            var cvs = document.createElement("canvas");
            cvs.width = width;
            cvs.height = height;
            var ctx = cvs.getContext('2d');
            ctx.drawImage(imgElement, 0, 0, width, height);
            callback(cvs);
          }
          function getDimensions(imgData, callback) {
            var tmpImg = document.createElement("img");
            tmpImg.onload = function () {
              callback(tmpImg.width, tmpImg.height, tmpImg);
            }
            tmpImg.src = imgData;
          }
        }

        $(function() {
          var $recordForm = $('#recordForm');
          $recordForm.on('submit', function (e) {
            var files = $('#input-file')[0].files;
            if(!files || !files[0]) {
              return;
            }
            resizeImageFromFile(files[0], 2560, 2560, function (dataURL) {
              $.post($recordForm.attr('action'), {
                photo: dataURL
              }).success(function (data) {
                window.location.href = data;
              }).error(function (error) {
                alert(error);
              });
            })
            e.preventDefault();
          });
        });

  script(type='text/javascript').
    var ESC_KEY = 27;
    jQuery(function() {

      function closeOverlay() {
        $('#detail-overlay').css('display', 'none');
      }

      $(window).on("keydown", function (evt) {
        if(evt.keyCode == ESC_KEY && $('#detail-overlay').attr('display') !== 'none') {
          closeOverlay();
          evt.preventDefault();
        }
      });

    $('#detail-overlay').find('a.close-centered').click(closeOverlay);

    function venueColorOfImage(image) {
      return thumbnailOfImage(image).parents('.venue').attr('class').match(/noisy_\w+/)[0]
    }

    function venueNameOfImage(image) {
      return thumbnailOfImage(image).parents('a').data('columntitle');
    }

    $('.timeline a.thumb').click(function(ev) {
      var $detailOverlay = $('#detail-overlay');
      $detailOverlay
        .removeClass('noisy_blue noisy_red noisy_green noisy_yellow')
        .addClass(venueColorOfImage(this.href));
      $detailOverlay.find('.tag').text(venueNameOfImage(this.href));
      setPreviousImage(previousImage(this.href));
      setCurrentImage(this.href);
      setNextImage(nextImage(this.href));
      $detailOverlay.fadeIn();
      return false;
    });

    function thumbnailOfImage(image) {
      return $('img.thumb').filter(function(index, thumbnail){
        return thumbnail.src.indexOf(image) !== -1;
      });
    }

    function previousImage(currentImage) {
      return thumbnailOfImage(currentImage).parent().prev('a').attr('href');
    }

    function nextImage(currentImage) {
      return thumbnailOfImage(currentImage).parent().next('a').attr('href');
    }

    function setPreviousImage(previousImage) {
      if(undefined === previousImage){
        $('.prev-img').addClass('disabled')
      } else {
        $('.prev-img').removeClass('disabled')
        $('.prev-img img').attr('src', previousImage + '?size=thumb');
      }
    }

    function setCurrentImage(currentImage) {
      $('#image-detail').attr('src', currentImage + '?size=preview');
      $('#image-detail-link').attr('href', currentImage);
    }

    function setNextImage(nextImage){
      if(undefined === nextImage){
        $('.next-img').addClass('disabled')
      } else {
        $('.next-img').removeClass('disabled')
        $('.next-img img').attr('src', nextImage + '?size=thumb');
      }
    }

    $('#prev-img').click(function(e) {
      var $image = $('#image-detail');
      var currentImage = $image.attr('src');
      var predecessor = previousImage(currentImage);
      if(predecessor){
        setPreviousImage(previousImage(predecessor));
        setCurrentImage(predecessor);
        setNextImage(currentImage);
      }
      return false;
    });
    $('#next-img').click(function(e) {
      var $image = $('#image-detail');
      var currentImage = $image.attr('src');
      var successor = nextImage(currentImage);
      if(successor) {
        setPreviousImage(currentImage);
        setCurrentImage(successor);
        setNextImage(nextImage(successor));
      }
      return false;
    });

    $('#recordForm').on('submit', function() {
      $('#recordForm button[type="submit"]').prepend($('<i class="fa fa-spinner fa-spin"/>&nbsp;'));
    });

    });
